import React, { useState } from "react";
import Spotify from "spotify-web-api-js";
import { MdDownloading, MdCheckCircle } from "react-icons/md";

import { useAuth } from "components/UserContext/UserContext";
import { Track, Link } from "types";
import LoginBanner from "components/LoginBanner/LoginBanner";

interface SavePlaylistProps {
  artistName: string;
  tracks: Track[];
  links?: Link[];
}

const SavePlaylist = ({ artistName, tracks, links }: SavePlaylistProps) => {
  const [loading, setLoading] = useState(false);
  const [done, setDone] = useState(false);
  const { user } = useAuth();
  if (!links || links.length === 0) {
    return null;
  }
  const songs = tracks
    .map(({ title }) => links?.find((link) => link.title === title)?.uri)
    .filter(Boolean) as string[];
  const createPlaylist = () => {
    if (user) {
      setLoading(true);
      const s = new Spotify();
      s.setAccessToken(user.accessToken);
      s.createPlaylist(user.user.id, {
        name: `${artistName} - Should I listen It?`,
        description: "Playlist generated by https://shouldilisten.it/",
        public: true,
      })
        .then((data) => {
          s.addTracksToPlaylist(data.id, songs);
          setDone(true);
        })
        .finally(() => setLoading(false));
    }
  };

  return (
    <div className="save-playlist">
      {loading ? (
        <MdDownloading />
      ) : done ? (
        <MdCheckCircle />
      ) : user ? (
        <button className="spotify-button" onClick={createPlaylist}>
          Save your playlist to Spotify
        </button>
      ) : (
        <LoginBanner />
      )}
    </div>
  );
};

export default SavePlaylist;
