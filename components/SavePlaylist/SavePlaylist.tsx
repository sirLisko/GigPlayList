import React, { useState } from "react";
import Link from "next/link";
import Spotify from "spotify-web-api-js";
import {
  MdDownloading,
  MdCheckCircle,
  MdOutlineArrowBack,
} from "react-icons/md";

import { useAuth } from "components/UserContext/UserContext";
import LoginBanner from "components/LoginBanner/LoginBanner";
import { matchSongs } from "utils/matchSongs";
import { Track, ArtistData } from "types";

import styles from "./SavePlaylist.module.scss";

interface SavePlaylistProps {
  artistData: ArtistData;
  tracks: Track[];
}

const SavePlaylist = ({
  artistData: { name, image, palette, tracks: links },
  tracks,
}: SavePlaylistProps) => {
  const [loading, setLoading] = useState(false);
  const [done, setDone] = useState(false);
  const { user } = useAuth();
  if (!links || links.length === 0) {
    return null;
  }
  const songs = matchSongs(tracks, links);
  const createPlaylist = () => {
    if (user) {
      setLoading(true);
      const s = new Spotify();
      s.setAccessToken(user.accessToken);
      s.createPlaylist(user.user.id, {
        name: `${name} - GigPlayList`,
        description: "Playlist generated by https://gigplaylist.sirlisko.com/",
        public: true,
      })
        .then((data) => {
          s.addTracksToPlaylist(data.id, songs);
          setDone(true);
        })
        .finally(() => setLoading(false));
    }
  };

  return (
    <div
      className={styles.container}
      style={{
        backgroundImage: `linear-gradient(
            rgb(${palette?.LightVibrant.rgb.join(", ")}) 5%,
            rgb(${palette?.Vibrant.rgb.join(", ")}) 25%,
            rgb(${palette?.DarkVibrant.rgb.join(", ")}),
            black
          )`,
      }}
    >
      <Link href="/" passHref>
        <a className={styles.backbutton}>
          <MdOutlineArrowBack />
        </a>
      </Link>
      <picture>
        <source srcSet={image} />
        <img
          src={image}
          alt={name}
          height={200}
          width={200}
          className={styles.image}
        />
      </picture>

      <div className={styles.artist}>{name}</div>
      {loading ? (
        <MdDownloading />
      ) : done ? (
        <MdCheckCircle />
      ) : (
        <LoginBanner onCreatePlaylist={createPlaylist} />
      )}
    </div>
  );
};

export default SavePlaylist;
